<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>TDR 16分類図鑑</title>
<meta name="description" content="TDRの16タイプを一覧で確認。クリックで該当タイプへスクロール。">
<style>
  body{margin:0;background:#0f1115;color:#e8ecf1;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif;line-height:1.7}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  h1{font-size:22px;margin:8px 0 4px}
  .sub{color:#9aa4b2;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:14px 0 10px}
  .chip{display:block;text-align:center;padding:10px 8px;border-radius:10px;background:#171a21;border:1px solid #ffffff22;color:#e8ecf1;text-decoration:none;font-weight:700}
  .chip:hover{background:#1d232f;border-color:#7dd3fc}
  .card{background:#171a21;border:1px solid #ffffff22;border-radius:12px;padding:14px;margin:12px 0}
  .code{font-family:ui-monospace,Menlo,monospace;font-weight:800}
  .sect{border-left:4px solid #22d3ee;padding-left:10px;margin-top:6px}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#ffffff10;border:1px solid #ffffff20}
  .foot{color:#9aa4b2;font-size:12px;margin-top:8px}
  .toplink{
    position:fixed;right:14px;bottom:14px;
  z-index:9999;              /* ←最前面へ */
  background:#7dd3fc;color:#081019;border:none;border-radius:999px;
  padding:10px 14px;font-weight:800;cursor:pointer;
  opacity:0; pointer-events:none; transition:opacity .2s;
  }
.toplink.show{ opacity:1; pointer-events:auto; }

</style>
</head>
<body>
<div class="wrap">
  <h1>TDR 16分類図鑑</h1>
  <div class="sub">上の一覧からタイプを選ぶと、ページ内の該当セクションへスクロールします。</div>

  <nav id="grid" class="grid"></nav>

  <main id="details"></main>

  <div class="foot">データはブラウザ内で読み込みます（<code>../data/types.json</code>）。</div>
</div>

<button type="button" id="toTop" class="toplink">▲ TOP</button>

<script>
(async function(){
  const MSG = (txt)=>{ 
    document.getElementById("grid").innerHTML = `<div class="sub">${txt}</div>`; 
  };

  try {
    // ここは types.json の実位置に合わせて
    const url = "../data/types.json";
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const raw = await res.json();

    // 配列でもオブジェクトでも受け取れるように正規化
    let types;
    if (Array.isArray(raw)) {
      types = raw;
    } else if (Array.isArray(raw.items)) {
      types = raw.items;
    } else {
      // { "E-HDR": {...}, ... } 形式なら値を配列化
      types = Object.values(raw);
    }

    if (!Array.isArray(types) || types.length === 0) {
      MSG("types.json は読み込めましたが、配列が空でした。構造を確認してください。");
      console.warn("raw:", raw);
      return;
    }

    // ソート（code を想定・なければ name）
    types.sort((a,b)=>(a.code||a.name).localeCompare(b.code||b.name));

    // 一覧（チップ）
    const grid = document.getElementById("grid");
    grid.innerHTML = types.map(t => 
      `<a class="chip" href="#${t.code||t.id}">${t.code||t.id}</a>`
    ).join("");

   // 画像パス補正関数
function resolveImg(p){
  if (!p) return "";
  if (/^https?:\/\//.test(p)) return p;            // 外部URLはそのまま
  if (p.startsWith("/")) return p;                 // 絶対パス指定もそのまま
  // atlas 下にいるときは1階層戻す
  return (location.pathname.includes("/atlas/") ? "../" : "") + p;
}

// 詳細
const details = document.getElementById("details");
details.innerHTML = types.map(t => {
  const code = t.code || t.id || "UNKNOWN";
  const name = t.name || "名称未設定";
  const desc = t.desc || t.description || "";
  const longdesc = t.longdesc || "";
  const adj  = t.adjust || {};
  const tags = t.tags ? t.tags.map(x=>`<span class="tag">${x}</span>`).join("") : "";
  const img  = resolveImg(t.img || "");

  return `
    <section id="${code}" class="card">
      <div class="sect">
        <div style="font-size:18px;font-weight:800">
          ${name} <span class="code">(${code})</span>
        </div>
        ${img ? `<img src="${img}" alt="${name}" style="max-height:300px;margin-top:6px;" onerror="this.remove()">` : ""}
        <div class="tags">${tags}</div>
      </div>
      <p style="margin-top:8px">${desc}</p>
      ${longdesc ? `<p style="margin-top:8px;font-size:14px;line-height:1.6">${longdesc}</p>` : ""}
      <div style="font-weight:700;margin-top:8px">逆方向調整</div>
      <ul style="margin:6px 0 0 18px">
        <li>内/外 （I/E）：${adj["I/E"] ?? "-"}</li>
        <li>温度T（H/C）：${adj["H/C"] ?? "-"}</li>
        <li>深さD（D/S）：${adj["D/S"] ?? "-"}</li>
        <li>硬さR（R/F）：${adj["R/F"] ?? "-"}</li>
      </ul>
    </section>
  `;
}).join("");
    
    // ハッシュ着地があればスクロール
    if (location.hash) {
      const el = document.querySelector(location.hash);
      el && el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // 内部リンクもスムースに
    document.querySelectorAll('a[href^="#"]').forEach(a=>{
      a.addEventListener("click", e=>{
        const id = a.getAttribute("href");
        const el = document.querySelector(id);
        if(el){
          e.preventDefault();
          history.replaceState(null,"",id);
          el.scrollIntoView({behavior:"smooth", block:"start"});
        }
      });
    });

    console.log(`Loaded types: ${types.length}`, types);
  } catch (err) {
    MSG(`読み込み失敗：${String(err)}`);
    console.error(err);
  }
})();

  // …既存の即時関数の下でもOK
  (function(){
    const btn = document.getElementById('toTop');
    // どっちがスクロール親でも効くように保険をかける
    function toTopSmooth(){
      try{ window.scrollTo({top:0, behavior:'smooth'}); }catch(e){}
      try{ document.documentElement.scrollTo({top:0, behavior:'smooth'}); }catch(e){}
      try{ document.body.scrollTo({top:0, behavior:'smooth'}); }catch(e){}
    }
    btn.addEventListener('click', toTopSmooth);

    // スクロール量で表示/非表示
    function onScroll(){
      const y = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
      if(y > 400) btn.classList.add('show'); else btn.classList.remove('show');
    }
    window.addEventListener('scroll', onScroll, {passive:true});
    onScroll(); // 初期評価
  })();
</script>

</body>
</html>
